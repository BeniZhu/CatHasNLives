function makeCards(e){for(var r=[],a=0;a<e.length;++a)for(var t=e[a],n=0;n<t.count;n++)r.push(t.card);return r}function getCards(e,r){for(var a=[],t=0;t<e.length;t++){var n=e[t];n.type==r&&-1==a.indexOf(n.name)&&a.push(n.name)}return a}function license(e){for(var r=makeCards(e.cardTable),a=e.players,t=0,n=[],o=r.length-a.length*e.cardEach,l=getCards(r,CardType.Privilege);;){n=[],t=0,r=makeCards(e.cardTable);for(var d=0;d<a.length;d++){var c=a[d];c.clearCards()}for(var d=0;o>d;d++){var p=void 0,s=void 0;do s=randomArray(r),p=r[s];while(p.cardType==CardType.Identity||e.keepResource&&p.cardType==CardType.Resource);n.push(p),r.splice(s,1)}if(!licenseResource(r,a,e.resourceRange))return{result:!1,abandonCards:[],players:[]};for(var i=0,u=!1;r.length>0;){if(t>e.retryTime){u=!0,console.log("发牌无解，重发");break}var s=randomArray(r),p=r[s],c=a[i];if(c.cards.length!=e.cardEach)if(p.cardType==CardType.Identity&&c.typeCardCount(CardType.Identity)>0)t++;else{for(var m=!1,d=l.length-1;d>=0;d--){var C=l[d];if(p.name==C&&c.hasCard(C)){m=!0;break}}m?t++:(c.giveCard(p),r.splice(s,1),i++,i==a.length&&(i=0))}else i++,i==a.length&&(i=0)}if(!u){calCamp(a,e.optionalCount,e.killerHelperCount,e.werewolfHelperCount);break}}return{result:!0,abandonCards:n,players:a}}function licenseResource(e,r,a){for(var t=[],n=e.length-1;n>=0;n--){var o=e[n];o.type==CardType.Resource&&(t.push(o),e.splice(n,1))}var l=a[0],d=a[1];if(t.length<l*r.length||t.length>d*r.length)return!1;for(var n=0;n<r.length;n++)for(var c=r[n],p=0;l>p;p++)c.giveCard(t.pop());for(;t.length>0;){var s=randomArray(r),c=r[s];c.typeCardCount(CardType.Resource)<d&&c.giveCard(t.pop())}return!0}function calCamp(e,r,a,t){for(var n=[],o=0;o<e.length;o++){var l=e[o];l.hasCard("杀手牌")?l.setCamp(Camp.Killer):l.hasCard("狼人牌")?l.setCamp(Camp.Werewolf):(l.setCamp(Camp.Unknow),n.push(l))}for(var o=0;r>o;o++){var d=randomArray(n),c=n[d];c.setCamp(Camp.Optional),n.splice(d,1)}for(var o=0;a>o;o++){var d=randomArray(n),c=n[d];c.setCamp(Camp.KillerHelper),n.splice(d,1)}for(var o=0;t>o;o++){var d=randomArray(n),c=n[d];c.setCamp(Camp.WereWolfHelper),n.splice(d,1)}for(var o=n.length-1;o>=0;o--)n[o].setCamp(Camp.People)}function randomArray(e){return Math.floor(Math.random()*e.length)}function getPlayers(e){for(var r=[],a=1;e>=a;a++){var t=document.getElementById("player_"+a).value;r.push(new Player(t))}return r}function getCardTable(){var e=[];return processCardStr(document.getElementById("cardIdentity").value,CardType.Identity,e),processCardStr(document.getElementById("cardResource").value,CardType.Resource,e),processCardStr(document.getElementById("cardPrivilege").value,CardType.Privilege,e),e}function processCardStr(e,r,a){for(var t=e.split("\n"),n=0;n<t.length;n++){var o=t[n],l=o.split(",");a.push(new CardTableItem(new Card(l[0],r),+l[1]))}}function doingLicense(){var e=getCardTable(),r=new Rule,a=+document.getElementById("playerCount").value;r.players=getPlayers(a),r.cardEach=+document.getElementById("cardEach").value,r.cardTable=e,r.optionalCount=+document.getElementById("optionalCount").value,r.killerHelperCount=+document.getElementById("killerHelperCount").value,r.werewolfHelperCount=+document.getElementById("werewolfHelperCount").value,r.keepResource=document.getElementById("keepResource").checked,r.resourceRange=[+document.getElementById("resourceMin").value,+document.getElementById("resourceMax").value],r.retryTime=20;for(var t=license(r),n="<tr><th>编号</th><th>玩家姓名</th><th>身份</th>",o=0;o<r.cardEach;o++)n+="<th class='card_item'></th>";n+="</tr>",document.getElementById("result").innerHTML=n;for(var o=0;o<t.players.length;o++){var l=t.players[o],d="<tr>";d+="<td>"+(o+1).toString()+"</td>",d+="<td>"+l.name+"</td>",d+="<td class='camp"+l.camp+"'>"+CampZH[Camp[l.camp]]+"</td>";for(var c=0;c<l.cards.length;c++){var p=l.cards[c];d+="<td class='card"+p.cardType+"'>"+p.name+"</td>"}d+="</tr>",document.getElementById("result").innerHTML+=d}for(var s="<tr><td>弃牌</td><td colspan="+(r.cardEach+2)+">",o=0;o<t.abandonCards.length;o++){var p=t.abandonCards[o];s+="【"+p.name+"】"}s+="</td></tr>",document.getElementById("result").innerHTML+=s}var Camp;!function(e){e[e.Killer=1]="Killer",e[e.Werewolf=2]="Werewolf",e[e.People=3]="People",e[e.Optional=4]="Optional",e[e.KillerHelper=5]="KillerHelper",e[e.WereWolfHelper=6]="WereWolfHelper",e[e.Unknow=7]="Unknow"}(Camp||(Camp={}));var CampZH={Killer:"杀手",Werewolf:"狼人",People:"平民",Optional:"可选",KillerHelper:"杀助",WereWolfHelper:"狼崽",Unknow:"未知"},CardType;!function(e){e[e.Identity=1]="Identity",e[e.Privilege=2]="Privilege",e[e.Resource=3]="Resource"}(CardType||(CardType={}));var Card=function(){function e(e,r){this.cardName=e,this.cardType=r,this.name=e,this.type=r}return e}(),CardTableItem=function(){function e(e,r){this.theCard=e,this.cardCount=r,this.card=e,this.count=r}return e}(),Player=function(){function e(e){this.playerName=e,this.name=e,this.cards=[],this.camp=Camp.Unknow}return e.prototype.hasCard=function(e){for(var r=0;r<this.cards.length;r++)if(this.cards[r].name==e)return!0;return!1},e.prototype.cardCount=function(e){for(var r=0,a=0;a<this.cards.length;a++)this.cards[a].name==e&&r++;return r},e.prototype.typeCardCount=function(e){for(var r=0,a=0;a<this.cards.length;a++){var t=this.cards[a];t.cardType==e&&r++}return r},e.prototype.giveCard=function(e){this.cards.push(e)},e.prototype.clearCards=function(){for(var e=[],r=0;r<this.cards.length;r++)e.push(this.cards[r]);return this.cards=[],e},e.prototype.setCamp=function(e){this.camp=e},e}(),Rule=function(){function e(){}return e}();