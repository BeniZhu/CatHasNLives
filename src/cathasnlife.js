function makeCards(a){for(var b=[],c=0;c<a.length;++c)for(var d=a[c],e=0;e<d.count;e++)b.push(d.card);return b}function getCards(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d];e.type==b&&-1==c.indexOf(e.name)&&c.push(e.name)}return c}function license(a){for(var b=makeCards(a.cardTable),c=a.players,d=0,e=[],f=b.length-c.length*a.cardEach,g=getCards(b,CardType.Privilege);;){e=[],d=0,b=makeCards(a.cardTable);for(var h=0;h<c.length;h++){var i=c[h];i.clearCards()}for(var h=0;f>h;h++){var j=void 0,k=void 0;do k=randomArray(b),j=b[k];while(j.cardType==CardType.Identity);e.push(j),b.splice(k,1)}if(!licenseResource(b,c,a.resourceRange))return{result:!1,abandonCards:[],players:[]};for(var l=0,m=!1;b.length>0;){if(d>a.retryTime){m=!0,console.log("\u53d1\u724c\u65e0\u89e3\uff0c\u91cd\u53d1");break}var k=randomArray(b),j=b[k],i=c[l];if(i.cards.length!=a.cardEach)if(j.cardType==CardType.Identity&&i.typeCardCount(CardType.Identity)>0)d++;else{for(var n=!1,h=g.length-1;h>=0;h--){var o=g[h];if(j.name==o&&i.hasCard(o)){n=!0;break}}n?d++:(i.giveCard(j),b.splice(k,1),l++,l==c.length&&(l=0))}else l++,l==c.length&&(l=0)}if(!m){calCamp(c,a.optionalCount);break}}return{result:!0,abandonCards:e,players:c}}function licenseResource(a,b,c){for(var d=[],e=a.length-1;e>=0;e--){var f=a[e];f.type==CardType.Resource&&(d.push(f),a.splice(e,1))}var g=c[0],h=c[1];if(d.length<g*b.length||d.length>h*b.length)return!1;for(var e=0;e<b.length;e++)for(var i=b[e],j=0;g>j;j++)i.giveCard(d.pop());for(;d.length>0;){var k=randomArray(b),i=b[k];i.typeCardCount(CardType.Resource)<h&&i.giveCard(d.pop())}return!0}function calCamp(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d];e.hasCard("\u6740\u624b\u724c")?e.setCamp(Camp.Killer):e.hasCard("\u72fc\u4eba\u724c")?e.setCamp(Camp.Werewolf):(e.setCamp(Camp.Unknow),c.push(e))}for(var d=0;b>d;d++){var f=randomArray(c),g=c[f];g.setCamp(Camp.Optional),c.splice(f,1)}for(var d=c.length-1;d>=0;d--)c[d].setCamp(Camp.People)}function randomArray(a){return Math.floor(Math.random()*a.length)}function getPlayers(a){for(var b=[],c=1;a>=c;c++){var d=document.getElementById("player_"+c).value;b.push(new Player(d))}return b}function getCardTable(){var a=[];return processCardStr(document.getElementById("cardIdentity").value,CardType.Identity,a),processCardStr(document.getElementById("cardResource").value,CardType.Resource,a),processCardStr(document.getElementById("cardPrivilege").value,CardType.Privilege,a),a}function processCardStr(a,b,c){for(var d=a.split("\n"),e=0;e<d.length;e++){var f=d[e],g=f.split(",");c.push(new CardTableItem(new Card(g[0],b),+g[1]))}}function doingLicense(){var a=getCardTable(),b=new Rule,c=+document.getElementById("playerCount").value;b.players=getPlayers(c),b.cardEach=+document.getElementById("cardEach").value,b.cardTable=a,b.optionalCount=+document.getElementById("optionalCount").value,b.resourceRange=[+document.getElementById("resourceMin").value,+document.getElementById("resourceMax").value],b.retryTime=20;for(var d=license(b),e="<tr><th>\u7f16\u53f7</th><th>\u73a9\u5bb6\u59d3\u540d</th><th>\u9635\u8425</th>",f=0;f<b.cardEach;f++)e+="<th></th>";e+="</tr>",document.getElementById("result").innerHTML=e;for(var f=0;f<d.players.length;f++){var g=d.players[f],h="<tr>";h+="<td>"+(f+1).toString()+"</td>",h+="<td>"+g.name+"</td>",h+="<td class='camp"+g.camp+"'>"+CampZH[Camp[g.camp]]+"</td>";for(var i=0;i<g.cards.length;i++){var j=g.cards[i];h+="<td class='card"+j.cardType+"'>"+j.name+"</td>"}h+="</tr>",document.getElementById("result").innerHTML+=h}for(var k="<tr><td>\u5f03\u724c</td><td colspan="+(b.cardEach+2)+">",f=0;f<d.abandonCards.length;f++){var j=d.abandonCards[f];k+="\u3010"+j.name+"\u3011"}k+="</td></tr>",document.getElementById("result").innerHTML+=k}var Camp;!function(a){a[a.Killer=1]="Killer",a[a.Werewolf=2]="Werewolf",a[a.People=3]="People",a[a.Optional=4]="Optional",a[a.Unknow=5]="Unknow"}(Camp||(Camp={}));var CampZH={Killer:"\u6740\u624b\u9635\u8425",Werewolf:"\u72fc\u4eba\u9635\u8425",People:"\u5e73\u6c11\u9635\u8425",Optional:"\u53ef\u9009\u9635\u8425",Unknow:"\u672a\u77e5\u9635\u8425"},CardType;!function(a){a[a.Identity=1]="Identity",a[a.Privilege=2]="Privilege",a[a.Resource=3]="Resource"}(CardType||(CardType={}));var Card=function(){function a(a,b){this.cardName=a,this.cardType=b,this.name=a,this.type=b}return a}(),CardTableItem=function(){function a(a,b){this.theCard=a,this.cardCount=b,this.card=a,this.count=b}return a}(),Player=function(){function a(a){this.playerName=a,this.name=a,this.cards=[],this.camp=Camp.Unknow}return a.prototype.hasCard=function(a){for(var b=0;b<this.cards.length;b++)if(this.cards[b].name==a)return!0;return!1},a.prototype.cardCount=function(a){for(var b=0,c=0;c<this.cards.length;c++)this.cards[c].name==a&&b++;return b},a.prototype.typeCardCount=function(a){for(var b=0,c=0;c<this.cards.length;c++){var d=this.cards[c];d.cardType==a&&b++}return b},a.prototype.giveCard=function(a){this.cards.push(a)},a.prototype.clearCards=function(){for(var a=[],b=0;b<this.cards.length;b++)a.push(this.cards[b]);return this.cards=[],a},a.prototype.setCamp=function(a){this.camp=a},a}(),Rule=function(){function a(){}return a}();