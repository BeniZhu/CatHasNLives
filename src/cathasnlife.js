function makeCards(a){for(var b=[],c=0;c<a.length;++c)for(var d=a[c],e=0;e<d.count;e++)b.push(d.card);return b}function getCards(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d];e.type==b&&-1==c.indexOf(e.name)&&c.push(e.name)}return c}function license(a){for(var b=makeCards(a.cardTable),c=a.players,d=0,e=[],f=b.length-c.length*a.cardEach,g=getCards(b,CardType.Privilege);;){e=[],d=0,b=makeCards(a.cardTable);for(var h=0;h<c.length;h++){var i=c[h];i.clearCards()}for(var h=0;f>h;h++){var j=void 0,k=void 0;do k=randomArray(b),j=b[k];while(j.cardType==CardType.Identity||a.keepResource&&j.cardType==CardType.Resource);e.push(j),b.splice(k,1)}if(!licenseResource(b,c,a.resourceRange))return{result:!1,abandonCards:[],players:[]};for(var l=0,m=!1;b.length>0;){if(d>a.retryTime){m=!0,console.log("\u53d1\u724c\u65e0\u89e3\uff0c\u91cd\u53d1");break}var k=randomArray(b),j=b[k],i=c[l];if(i.cards.length!=a.cardEach)if(j.cardType==CardType.Identity&&i.typeCardCount(CardType.Identity)>0)d++;else{for(var n=!1,h=g.length-1;h>=0;h--){var o=g[h];if(j.name==o&&i.hasCard(o)){n=!0;break}}n?d++:(i.giveCard(j),b.splice(k,1),l++,l==c.length&&(l=0))}else l++,l==c.length&&(l=0)}if(!m){calCamp(c,a.optionalCount,a.killerHelperCount,a.werewolfHelperCount);break}}return{result:!0,abandonCards:e,players:c}}function licenseResource(a,b,c){for(var d=[],e=a.length-1;e>=0;e--){var f=a[e];f.type==CardType.Resource&&(d.push(f),a.splice(e,1))}var g=c[0],h=c[1];if(d.length<g*b.length||d.length>h*b.length)return!1;for(var e=0;e<b.length;e++)for(var i=b[e],j=0;g>j;j++)i.giveCard(d.pop());for(;d.length>0;){var k=randomArray(b),i=b[k];i.typeCardCount(CardType.Resource)<h&&i.giveCard(d.pop())}return!0}function calCamp(a,b,c,d){for(var e=[],f=0;f<a.length;f++){var g=a[f];g.hasCard("\u6740\u624b\u724c")?g.setCamp(Camp.Killer):g.hasCard("\u72fc\u4eba\u724c")?g.setCamp(Camp.Werewolf):(g.setCamp(Camp.Unknow),e.push(g))}for(var f=0;b>f;f++){var h=randomArray(e),i=e[h];i.setCamp(Camp.Optional),e.splice(h,1)}for(var f=0;c>f;f++){var h=randomArray(e),i=e[h];i.setCamp(Camp.KillerHelper),e.splice(h,1)}for(var f=0;d>f;f++){var h=randomArray(e),i=e[h];i.setCamp(Camp.WereWolfHelper),e.splice(h,1)}for(var f=e.length-1;f>=0;f--)e[f].setCamp(Camp.People)}function randomArray(a){return Math.floor(Math.random()*a.length)}function getPlayers(a){for(var b=[],c=1;a>=c;c++){var d=document.getElementById("player_"+c).value;b.push(new Player(d))}return b}function getCardTable(){var a=[];return processCardStr(document.getElementById("cardIdentity").value,CardType.Identity,a),processCardStr(document.getElementById("cardResource").value,CardType.Resource,a),processCardStr(document.getElementById("cardPrivilege").value,CardType.Privilege,a),a}function processCardStr(a,b,c){for(var d=a.split("\n"),e=0;e<d.length;e++){var f=d[e],g=f.split(",");c.push(new CardTableItem(new Card(g[0],b),+g[1]))}}function doingLicense(){var a=getCardTable(),b=new Rule,c=+document.getElementById("playerCount").value;b.players=getPlayers(c),b.cardEach=+document.getElementById("cardEach").value,b.cardTable=a,b.optionalCount=+document.getElementById("optionalCount").value,b.killerHelperCount=+document.getElementById("killerHelperCount").value,b.werewolfHelperCount=+document.getElementById("werewolfHelperCount").value,b.keepResource=document.getElementById("keepResource").checked,b.resourceRange=[+document.getElementById("resourceMin").value,+document.getElementById("resourceMax").value],b.retryTime=20;for(var d=license(b),e="<tr><th>\u7f16\u53f7</th><th>\u73a9\u5bb6\u59d3\u540d</th><th>\u8eab\u4efd</th>",f=0;f<b.cardEach;f++)e+="<th class='card_item'></th>";e+="</tr>",document.getElementById("result").innerHTML=e;for(var f=0;f<d.players.length;f++){var g=d.players[f],h="<tr>";h+="<td>"+(f+1).toString()+"</td>",h+="<td>"+g.name+"</td>",h+="<td class='camp"+g.camp+"'>"+CampZH[Camp[g.camp]]+"</td>";for(var i=0;i<g.cards.length;i++){var j=g.cards[i];h+="<td class='card"+j.cardType+"'>"+j.name+"</td>"}h+="</tr>",document.getElementById("result").innerHTML+=h}for(var k="<tr><td>\u5f03\u724c</td><td colspan="+(b.cardEach+2)+">",f=0;f<d.abandonCards.length;f++){var j=d.abandonCards[f];k+="\u3010"+j.name+"\u3011"}k+="</td></tr>",document.getElementById("result").innerHTML+=k}function setRule(a){document.getElementById("playerCount").value=a.playerCount.toString(),document.getElementById("cardEach").value=a.cardEach.toString(),document.getElementById("optionalCount").value=a.optionalCount.toString(),document.getElementById("killerHelperCount").value=a.killerHelperCount.toString(),document.getElementById("werewolfHelperCount").value=a.werewolfHelperCount.toString(),document.getElementById("resourceMin").value=a.resourceRange[0].toString(),document.getElementById("resourceMax").value=a.resourceRange[1].toString(),document.getElementById("keepResource").checked=a.keepResource,document.getElementById("cardIdentity").value=a.cardIdentity,document.getElementById("cardResource").value=a.cardResource,document.getElementById("cardPrivilege").value=a.cardPrivilege}var Camp;!function(a){a[a.Killer=1]="Killer",a[a.Werewolf=2]="Werewolf",a[a.People=3]="People",a[a.Optional=4]="Optional",a[a.KillerHelper=5]="KillerHelper",a[a.WereWolfHelper=6]="WereWolfHelper",a[a.Unknow=7]="Unknow"}(Camp||(Camp={}));var CampZH={Killer:"\u6740\u624b",Werewolf:"\u72fc\u4eba",People:"\u5e73\u6c11",Optional:"\u53ef\u9009",KillerHelper:"\u6740\u52a9",WereWolfHelper:"\u72fc\u5d3d",Unknow:"\u672a\u77e5"},CardType;!function(a){a[a.Identity=1]="Identity",a[a.Privilege=2]="Privilege",a[a.Resource=3]="Resource"}(CardType||(CardType={}));var Card=function(){function a(a,b){this.cardName=a,this.cardType=b,this.name=a,this.type=b}return a}(),CardTableItem=function(){function a(a,b){this.theCard=a,this.cardCount=b,this.card=a,this.count=b}return a}(),Player=function(){function a(a){this.playerName=a,this.name=a,this.cards=[],this.camp=Camp.Unknow}return a.prototype.hasCard=function(a){for(var b=0;b<this.cards.length;b++)if(this.cards[b].name==a)return!0;return!1},a.prototype.cardCount=function(a){for(var b=0,c=0;c<this.cards.length;c++)this.cards[c].name==a&&b++;return b},a.prototype.typeCardCount=function(a){for(var b=0,c=0;c<this.cards.length;c++){var d=this.cards[c];d.cardType==a&&b++}return b},a.prototype.giveCard=function(a){this.cards.push(a)},a.prototype.clearCards=function(){for(var a=[],b=0;b<this.cards.length;b++)a.push(this.cards[b]);return this.cards=[],a},a.prototype.setCamp=function(a){this.camp=a},a}(),Rule=function(){function a(){}return a}(),rule_7={playerCount:7,cardEach:5,optionalCount:1,killerHelperCount:0,werewolfHelperCount:0,resourceRange:[1,2],keepResource:!1,cardIdentity:"\u6740\u624b\u724c,1\n\u72fc\u4eba\u724c,1",cardResource:"\u5eb6\u6c11\u724c,12",cardPrivilege:"\u72d9\u51fb\u624b\u724c,2\n\u675f\u9b42\u724c,2\n\u5deb\u533b\u724c,2\n\u9632\u5f39\u8863/\u72fc\u6bd2\u724c,2\n\u7981\u9522/\u53cd\u72d9\u51fb\u724c,2\n\u7edd\u6740/\u7279\u8d66\u724c,2\n\u8bc5\u5492/\u5e87\u4f51\u724c,2\n\u7eb5\u706b/\u5723\u4eba\u724c,2\n\u4fdd\u9556\u724c,3\n\u963f\u7c73\u5df4\u53d8\u5f62\u724c,3"},rule_9={playerCount:9,cardEach:6,optionalCount:0,killerHelperCount:1,werewolfHelperCount:1,resourceRange:[3,3],keepResource:!0,cardIdentity:"\u6740\u624b\u724c,1\n\u72fc\u4eba\u724c,1",cardResource:"\u5eb6\u6c11\u724c,27",cardPrivilege:"\u72d9\u51fb\u624b\u724c,3\n\u675f\u9b42\u724c,3\n\u5deb\u533b\u724c,3\n\u9632\u5f39\u8863/\u72fc\u6bd2\u724c,3\n\u7981\u9522/\u53cd\u72d9\u51fb\u724c,2\n\u7edd\u6740/\u7279\u8d66\u724c,2\n\u8bc5\u5492/\u5e87\u4f51\u724c,2\n\u7eb5\u706b/\u5723\u4eba\u724c,2\n\u4fdd\u9556\u724c,4\n\u963f\u7c73\u5df4\u53d8\u5f62\u724c,4"};